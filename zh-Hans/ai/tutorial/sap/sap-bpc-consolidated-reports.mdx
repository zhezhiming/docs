---
title: SAP BPC 合并报表
sidebar_position: 2
---

本文以 SAP BPC 系统中的环境 **BPC420_00** 中的模型 **Consolidation** 为例介绍如何搭建财务合并报表的分析体系.

BPC 环境:

![Tiny Shadow](./bpc-env.png)

BPC 模型:

![Middle Shadow](./consolidation-model.png)

:::tip 环境

本文所用系统环境: Personal Edition 账号

:::

## 如何基于 SAP BPC 系统创建看板

1. 创建 SAP BPC 系统数据源
2. 创建 SAP BPC 系统中财务管理报告模型对应的语义模型
3. 创建指标组
4. 根据管理报表语义模型创建指标

### 1. 创建 BPC 系统数据源

SAP BPC 是基于 SAP BW 系统的, 所以创建 SAP BPC 系统的数据源请参考 [SAP BW 数据源](../../../server/datasources/sap-bw).

### 2. 创建业务分组

语义模型, 指标和故事都是按业务域进行管理的, 所以要进行分组和权限控制, 需要创建相应的业务域分组架构. 参考[业务域文档](../../../server/organization/business-area)

创建一个业务域命名为 **财务**.


### 3. 创建语义模型

语义模型作为元数据管理对象是系统对数据进行分析的基础. 要对语义模型进行权限管控需要将语义模型创建在相应业务域内. 打开语义模型管理界面:

1. 在业务域**财务**行上点击新建按钮, 选择上面步骤创建的 BPC 数据源, 点击下一步;
2. 选择 Catalog **$INFOCUBE**, 输入模型名称, 点击创建

现在创建好的语义模型是一个只有基础配置的, 如果需要对 SAP BW 模型的元数据进行增强的话需要在此语义模型中创建相应的 Cube 或者 Dimension 并新增相应的增强元数据.

通过以下方式找到 BPC 模型对应的 BW 模型, 打开 BW 系统 SAP GUI, 使用事务码 **SE11** 查看表 **UJA_APPL** 内容, 选择条件为 APPSET_ID: *BPC420_00*, APPLICATION_ID: *Consolidation*. 会得到一条表记录, 找到字段 INFOCUBE 的值如 */CPMB/FOITS7D* 即为 BW 模型.

![Middle Shadow](./bpc-applications.png)

在语义模型界面中的数据表区域查找此模型, 将其拖至 MDX 模型区域, 输入文本描述后即创建了相应的语义模型实体.

![Small Shadow](./semantic-model.png)


创建 BW 模型在语义模型中对应的实体后, 页面会跳转到模型编辑界面, 左边栏会出现系统自动获取到的此模型的维度和度量信息结构.

现在要对此原始元数据进行增强增加默认的时间层级和计算度量信息 [增强时间层级维度](../../../models/mdx-modeling/semantic-enhancement-for-third-party-olap-cube#增强日历类型维度):

#### 创建计算度量

由于 BPC 模型存储的收入金额为负值, 所以在展示时需要对收入金额取负值, 这时就可以使用计算度量来实现.

在左边栏计算成员组点击创建, 选中新加行节点, 在右边设置栏输入 Name: amount, Label: 金额, Formula: `-[Measures].[/CPMB/SDATA]`.

### 4. 创建故事仪表板

接下来就是根据语义模型创建相应的报表看板了, 在语义模型界面中选择菜单 *常规* -> *故事* -> *创建故事* 创建故事. 也可以在故事列表界面(先选择相应的业务组)点击创建按钮进行创建.

然后就可以在故事编辑界面绘制想要分析的看板了.

## 为 BPC 财务模型搭建指标体系

企业财务分析指标体系是企业财务管理中的一项重要内容, 它作为企业信息分析的重要资源,为企业决策者提供财务分析数据资料,做出科学的决策, 实现企业价值最大化目标发挥了积极的支撑和保障作用。

基于 BPC 模型我们来创建 4 中财务核心指标: **偿债能力**, **盈利能力**, **营运能力**, **发展能力**.

### 1. 创建核心指标业务域

为了更好的管理财务指标我们为其在**财务**业务域下创建单独的**核心指标**业务域. 然后在核心指标域下创建四个子域: 偿债能力, 盈利能力, 营运能力, 发展能力.

### 2. 创建指标

以偿债能力中的**资产负债率**为例创建指标, 参考 [指标注册](../../../indicators/register) 文档填写相应信息. 这里指标名称和代码的命名规范需要客户根据自己的需要进行规范管理, 系统本身没有限制. 选择数据源和模型后, 指标类型选择为**衍生指标**, 在衍生指标下可以设置计算度量公式: `([Account Dim].[负债合计], [Measures].[金额]) / ([Account Dim].[资产合计], [Measures].[金额])` , 并在基础信息中将单位设置为 **%**.

在指标注册页面通过手工录入或者批量上传的方式将指标注册进系统. 然后在 Story 中就可以选择使用指标进行展示了. 也可以在 [指标应用](../../../indicators/app/) 中查看和收藏指标列表.

### 3. 明细指标

基于不同公司的管理方法不同, 核心指标还可以下钻到明细指标进行定义. 例如盈利能力中的毛利率, 核心指标中可以定义为集团总的毛利率, 也可以为不同销售区域定义明细的毛利率如: **中国区毛利率**, **海外毛利率**. 还可以针对不同产品线定义: **汽车产品毛利率**, **手机产品毛利率**, **家电产品毛利率** 等.

这种情况下毛利率公式不变, 变化的是不同的维度成员. 这样我们可以将毛利率公式放到语义模型中进行定义. 在 [语义模型 #创建计算成员](../../../models/mdx-modeling/semantic-enhancement-for-third-party-olap-cube#创建计算成员) 中新增毛利率的计算度量成员, 并在指标定义时选择此度量, 然后针对不同的明细指标添加不同的筛选条件(维度成员限制).

:::tip Solve Order

定义计算度量成员时需要注意 Solve Order 属性的设置, 它关系到计算过程中不同操作的优先顺序并影响着最终结果.

--- [MDX Data Manipulation - Understanding Pass Order and Solve Order](https://learn.microsoft.com/en-us/analysis-services/multidimensional-models/mdx/mdx-data-manipulation-understanding-pass-order-and-solve-order?view=asallproducts-allversions)

:::

## 日历维度

因为财务数据都是对期间的分析, 所以需要用到日历维度作为公共的时间轴. 在语义模型中设置相应的默认日历维度:

参考 [Calendar Dimension](../../../models/mdx-modeling/calendar-dimension)
