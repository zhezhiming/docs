---
sidebar_position: 6
title: æ’ä»¶ç¤ºä¾‹ï¼šé£ä¹¦æ–‡æ¡£
---

æœ¬ç¯‡å±•ç¤ºä¸€ä¸ªå®Œæ•´çš„æ’ä»¶ç¤ºä¾‹ï¼ŒåŸºäº [é£ä¹¦](https://www.feishu.cn/) å¹³å°å®ç°ã€‚
ç¤ºä¾‹åŒ…å«æ’ä»¶åŠŸèƒ½ã€é…ç½®ã€ä»£ç ç»“æ„ã€æ¥å£å®ç°ã€å¢å¼ºç‚¹ç­‰å†…å®¹ï¼Œå¸®åŠ©ä½ ç†è§£å¦‚ä½•åœ¨ **Xpert AI å¹³å°** å¼€å‘ç±»ä¼¼çš„é›†æˆæ’ä»¶ã€‚

---

## èƒŒæ™¯ä»‹ç»

Xpert AI æ’ä»¶ç³»ç»Ÿå…è®¸å¼€å‘è€…é€šè¿‡ **æ’ä»¶æ‰©å±•** å¹³å°åŠŸèƒ½ã€‚ä»¥é£ä¹¦æ–‡æ¡£ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¸Œæœ›å®ç°ä»¥ä¸‹åœºæ™¯ï¼š

* **ç³»ç»Ÿé›†æˆ**ï¼šæ¥å…¥é£ä¹¦åº”ç”¨çš„ AppIDã€AppSecret ç­‰å‡­è¯ï¼Œå®Œæˆé‰´æƒã€‚
* **æ–‡æ¡£åŠ è½½**ï¼šä»é£ä¹¦çš„æ–‡ä»¶å¤¹æˆ–æ–‡æ¡£ API ä¸­è·å–æ–‡æ¡£å†…å®¹ã€‚
* **çŸ¥è¯†ç®¡ç†**ï¼šå°†æ–‡æ¡£è½¬åŒ–ä¸ºå¯ä¾› Xpert AI çŸ¥è¯†åº“å’Œæ™ºèƒ½ä½“ä½¿ç”¨çš„ç»“æ„åŒ–å†…å®¹ã€‚
* **æ‰©å±•ç­–ç•¥**ï¼šé€šè¿‡ç­–ç•¥ï¼ˆStrategyï¼‰æ¥å£è§„èŒƒï¼Œå®ç°æ¥å…¥ã€æ–‡æ¡£æºã€æ–‡æ¡£è½¬æ¢çš„æ‰©å±•ç‚¹ã€‚

æœ€ç»ˆæ•ˆæœæ˜¯ï¼šç”¨æˆ·åªéœ€é…ç½®å¥½é£ä¹¦é›†æˆä¿¡æ¯ï¼ŒXpert AI å°±èƒ½è‡ªåŠ¨ä»é£ä¹¦æ–‡æ¡£ä¸­è¯»å–å†…å®¹ï¼Œå¹¶å°†å…¶çº³å…¥ AI å¯¹è¯å’ŒçŸ¥è¯†åº“ä¹‹ä¸­ã€‚

---

## 1. å…‹éš†æ’ä»¶æ¨¡ç‰ˆ

æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª **æ’ä»¶å¼€å‘èµ·ç‚¹æ¨¡ç‰ˆ**ï¼Œæ–¹ä¾¿å¿«é€Ÿæ„å»ºæ–°çš„æ’ä»¶ï¼š

```sh
git clone git@github.com:xpert-ai/xpert-plugins-starter.git lark
cd lark
```

å®‰è£…ä¾èµ–ï¼š

```sh
npm install
```

ä½¿ç”¨ `nx` æ–°å»ºä¸€ä¸ªæ’ä»¶åº“ï¼Œå…¶ä¸­ `packages/lark` æ˜¯æ’ä»¶ä»£ç åœ¨é¡¹ç›®ä¸­çš„ç›®å½•ï¼Œ`@xpert-ai/plugin-lark` æ˜¯æ’ä»¶ npm åŒ…åï¼š

```sh
npx nx g @nx/js:lib packages/lark \
  --publishable \
  --importPath=@xpert-ai/plugin-lark \
  --bundler=tsc \
  --unitTestRunner=jest \
  --linter=eslint
```

ç¡®è®¤æ’ä»¶ä¿¡æ¯ï¼š

```sh
npx nx show project @xpert-ai/plugin-lark
```

> âœ… è¿™é‡Œæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªåä¸º **`@xpert-ai/plugin-lark`** çš„æ’ä»¶ï¼Œå®ƒå°†æ‰¿è½½é£ä¹¦æ–‡æ¡£çš„æ‰€æœ‰é›†æˆåŠŸèƒ½ã€‚

---

## 2. æ’ä»¶å…¥å£ä»£ç 

æ’ä»¶çš„å…¥å£ä»£ç ä¸»è¦åŒ…å« **å…ƒä¿¡æ¯ï¼ˆmetaï¼‰ã€é…ç½®ï¼ˆconfigï¼‰ã€ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼ˆregister/onStart/onStopï¼‰**ã€‚

```ts
import { z } from 'zod';
import { type XpertPlugin } from '@xpert-ai/plugin-sdk';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { initI18n } from './lib/i18n.js';
import { LarkModule } from './lib/lark.module.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const ConfigSchema = z.object({});

const plugin: XpertPlugin<z.infer<typeof ConfigSchema>> = {
  meta: {
    name: '@xpert-ai/plugin-lark',
    version: '1.0.0',
    category: 'doc-source',
    displayName: 'Lark Plugin',
    description: 'Integrate Lark functionality',
    keywords: ['lark', 'feishu', 'document source'],
    author: 'Xpert AI team',
  },
  config: {
    schema: ConfigSchema,
  },
  register(ctx) {
    ctx.logger.log('register lark plugin');
    initI18n(join(__dirname, '../src'));
    return { module: LarkModule, global: true };
  },
  async onStart(ctx) {
    ctx.logger.log('lark plugin started');
  },
  async onStop(ctx) {
    ctx.logger.log('lark plugin stopped');
  },
};

export default plugin;
```

### æ ¸å¿ƒè¦ç‚¹

1. **meta**ï¼šå®šä¹‰æ’ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼ˆåå­—ã€ç‰ˆæœ¬ã€åˆ†ç±»ã€å…³é”®è¯ç­‰ï¼‰ã€‚
2. **config**ï¼šæè¿°æ’ä»¶çš„é…ç½® Schemaï¼Œç”¨æˆ·å¯åœ¨ UI ä¸­è¾“å…¥é…ç½®ç­‰ï¼ˆé¢„ç•™æœºåˆ¶ï¼Œæš‚æœªå®ç°ï¼‰ã€‚
3. **register**ï¼šæ³¨å†Œ `LarkModule`ï¼Œå°†æ’ä»¶æŒ‚è½½åˆ° NestJS æ¨¡å—ä½“ç³»ã€‚
4. **onStart/onStop**ï¼šæ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚

---

## 3. NestJS æ¨¡å—ç»“æ„

æ’ä»¶å®é™…æ˜¯ä¸€ä¸ª [NestJS æ¨¡å—](https://docs.nestjs.com/modules)ï¼ˆ`LarkModule`ï¼‰ï¼Œå®ƒå°†ä¸åŒçš„ **ç­–ç•¥ç±»ï¼ˆStrategyï¼‰ã€æ§åˆ¶å™¨ï¼ˆControllerï¼‰æˆ–è€…æœåŠ¡ï¼ˆServiceï¼‰** æ³¨å†Œè¿›æ¥ã€‚

```ts
import chalk from 'chalk';
import { XpertServerPlugin, IOnPluginBootstrap, IOnPluginDestroy } from '@xpert-ai/plugin-sdk';
import { LarkIntegrationStrategy } from './integration.strategy.js';
import { LarkController } from './lark.controller.js';
import { LarkSourceStrategy } from './source.strategy.js';
import { LarkDocTransformerStrategy } from './transformer.strategy.js';

@XpertServerPlugin({
	controllers: [LarkController],
	providers: [
		LarkIntegrationStrategy,
		LarkSourceStrategy,
		LarkDocTransformerStrategy
	]
})
export class LarkModule implements IOnPluginBootstrap, IOnPluginDestroy {
	onPluginBootstrap(): void {
		console.log(chalk.green(`${LarkModule.name} is being bootstrapped...`));
	}
	onPluginDestroy(): void {
		console.log(chalk.green(`${LarkModule.name} is being destroyed...`));
	}
}
```

> âœ… è¿™é‡Œçš„ `Strategy` å°±æ˜¯æ’ä»¶çš„æ‰©å±•ç‚¹ï¼Œä¾‹å¦‚ï¼š
>
> * `LarkIntegrationStrategy`ï¼šå¤„ç†ä¸é£ä¹¦ç³»ç»Ÿçš„é›†æˆã€‚
> * `LarkSourceStrategy`ï¼šå®šä¹‰å¦‚ä½•ä»é£ä¹¦åŠ è½½æ–‡æ¡£ã€‚
> * `LarkDocTransformerStrategy`ï¼šå®šä¹‰å¦‚ä½•å°†æ–‡æ¡£è½¬åŒ–ä¸ºçŸ¥è¯†åº“å¯ç”¨çš„æ ¼å¼ã€‚

---

## 4. API æ¥å£

[æ§åˆ¶å™¨](https://docs.nestjs.com/controllers) ç”¨äºæš´éœ²æ’ä»¶çš„ REST æ¥å£ã€‚ä¾‹å¦‚ï¼šæµ‹è¯•è¿æ¥é£ä¹¦ã€‚

```ts
@Post('test')
async connect(@Body() integration: IIntegration) {
  try {
    const botInfo = await this.integrationStrategy.validateConfig(integration.options)
    return integration
  } catch (err) {
    throw new ForbiddenException('Credentials failed')
  }
}
```

è°ƒç”¨ `/lark/test` æ¥å£æ—¶(ç›®å‰æ˜¯æµ‹è¯•ç³»ç»Ÿé›†æˆè¿é€šæ€§çš„é»˜è®¤è·¯å¾„è§„åˆ™ï¼Œåç»­ä¼šæ”¹æˆç»Ÿä¸€éªŒè¯æ¥å£)ï¼Œç³»ç»Ÿä¼šå»éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆAppID/AppSecret æ˜¯å¦æœ‰æ•ˆï¼‰ã€‚

---

## 5. æ’ä»¶å¢å¼ºç‚¹

### 5.1 ç³»ç»Ÿé›†æˆå¢å¼º

[ç³»ç»Ÿé›†æˆç­–ç•¥ `LarkIntegrationStrategy`](./integration/) ç”¨äºå¤„ç†é£ä¹¦åº”ç”¨å‡­è¯éªŒè¯ï¼Œè·å–æœºå™¨äººä¿¡æ¯ç­‰ã€‚

å…³é”®é€»è¾‘ï¼š

```ts
async validateConfig(config: TLarkIntegrationConfig) {
  if (!config.appId || !config.appSecret) {
    throw new Error('App ID and Secret required')
  }
  const larkClient = new LarkClient({ options: config } as IIntegration)
  const botInfo = await larkClient.getBotInfo()
  if (!botInfo) throw new ForbiddenException('Bot permission denied')
  return botInfo
}
```

> âœ… è¿™é‡Œä½¿ç”¨ `LarkClient` å°è£…é£ä¹¦ OpenAPI è¯·æ±‚ã€‚

---

### 5.2 æ–‡æ¡£æºå¢å¼º

[æ–‡æ¡£æºç­–ç•¥ `LarkSourceStrategy`](./source/) å®šä¹‰å¦‚ä½•ä»é£ä¹¦ä¸­è·å–æ–‡æ¡£åˆ—è¡¨ã€‚

* é…ç½®å‚æ•°ï¼šæ–‡ä»¶å¤¹ Tokenã€æ–‡æ¡£ç±»å‹ï¼ˆdocx/sheet/fileç­‰ï¼‰ã€‚
* åŠ è½½é€»è¾‘ï¼šè°ƒç”¨ `client.listDriveFiles(folderToken)`ï¼Œè¿”å› `Document[]`ã€‚

---

### 5.3 æ–‡æ¡£è½¬æ¢å¢å¼º

[æ–‡æ¡£è½¬æ¢ç­–ç•¥ `LarkDocTransformerStrategy`](./transformer/) å®šä¹‰å¦‚ä½•å°†æ–‡æ¡£å†…å®¹è½¬åŒ–ä¸ºçŸ¥è¯†åº“æ¡ç›®ã€‚

* è°ƒç”¨é£ä¹¦ API è·å–æ–‡æ¡£æ­£æ–‡ã€‚
* å°†æ­£æ–‡åˆ‡åˆ†ä¸º `Document`ï¼ˆå¯ä¾›å‘é‡åŒ–ï¼‰ã€‚
* è¾“å‡ºä¸º `IKnowledgeDocument` æ ¼å¼ã€‚

---

### 5.4 å®¢æˆ·ç«¯å°è£…

æ‰€æœ‰ API è¯·æ±‚éƒ½é€šè¿‡ `LarkClient` ç»Ÿä¸€å°è£… `@larksuiteoapi/node-sdk` åŠŸèƒ½ï¼Œæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š

* `getBotInfo()` è·å–æœºå™¨äººä¿¡æ¯
* `listDriveFiles(folderToken)` åˆ—å‡ºæ–‡ä»¶å¤¹å†…å®¹
* `getDocumentContent(docToken)` è·å–æ–‡æ¡£æ­£æ–‡
* `getAllDocsInFolder(folderToken)` é€’å½’è·å–æ‰€æœ‰æ–‡æ¡£

è¿™æ ·ï¼Œæ’ä»¶çš„ **ç­–ç•¥å±‚åªéœ€è°ƒç”¨ Client æ–¹æ³•**ï¼Œæ— éœ€å…³å¿ƒ API ç»†èŠ‚ã€‚

---

## 6. å¼€å‘æµç¨‹æ€»ç»“

1. **å‡†å¤‡æ¨¡ç‰ˆ**ï¼šå…‹éš†æ’ä»¶æ¨¡ç‰ˆå¹¶ç”Ÿæˆæ’ä»¶é¡¹ç›®ã€‚
2. **ç¼–å†™å…¥å£**ï¼šå®šä¹‰æ’ä»¶ metaã€config å’Œç”Ÿå‘½å‘¨æœŸã€‚
3. **æ„å»ºæ¨¡å—**ï¼šåœ¨ `LarkModule` ä¸­æ³¨å†Œæ§åˆ¶å™¨å’Œç­–ç•¥ç±»ã€‚
4. **å®ç°ç­–ç•¥**ï¼š

   * é›†æˆç­–ç•¥ï¼šå¤„ç† AppIDã€Secret éªŒè¯ã€‚
   * æ–‡æ¡£æºç­–ç•¥ï¼šä»é£ä¹¦è·å–æ–‡æ¡£ã€‚
   * è½¬æ¢ç­–ç•¥ï¼šæŠŠæ–‡æ¡£è½¬åŒ–ä¸ºçŸ¥è¯†åº“å†…å®¹ã€‚
5. **å°è£…å®¢æˆ·ç«¯**ï¼šç»Ÿä¸€ç®¡ç†é£ä¹¦ API è°ƒç”¨ã€‚
6. **æµ‹è¯•æ¥å£**ï¼šé€šè¿‡ `/lark/test` éªŒè¯é›†æˆæ˜¯å¦æ­£å¸¸ã€‚

## 7. æ„å»ºã€å‘å¸ƒä¸ npm å‘å¸ƒæµç¨‹

å½“æˆ‘ä»¬å®Œæˆäº† `@xpert-ai/plugin-lark` æ’ä»¶çš„å¼€å‘ï¼Œå°±å¯ä»¥é€šè¿‡ **Nx æä¾›çš„æ„å»ºä¸å‘å¸ƒå·¥å…·é“¾** å°†å…¶æ„å»ºå¹¶å‘å¸ƒåˆ° npm ä»“åº“ã€‚æ•´ä¸ªæµç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

### 7.1 æ„å»ºæ’ä»¶

æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼š

```bash
npx nx build @xpert-ai/plugin-lark
```

* è¯¥å‘½ä»¤ä¼šè°ƒç”¨ Nx çš„æ„å»ºå™¨ï¼ˆé»˜è®¤ä½¿ç”¨ TypeScript ç¼–è¯‘å™¨ `tsc`ï¼‰ï¼Œå°†æºç ç¼–è¯‘ä¸º JavaScriptã€‚
* æ„å»ºç»“æœä¼šè¾“å‡ºåˆ°ï¼š

  ```
  packages/lark/dist
  ```
* è¾“å‡ºç›®å½•ä¸­çš„å†…å®¹å°±æ˜¯å¯å‘å¸ƒçš„äº§ç‰©ï¼ˆåŒ…å« `index.js`ã€ç±»å‹å£°æ˜ `.d.ts` ç­‰ï¼‰ã€‚

### 7.2 ç‰ˆæœ¬ç®¡ç†

ä¸ºäº†ç¡®ä¿ npm åŒ…çš„è¿­ä»£è§„èŒƒï¼Œéœ€è¦æ­£ç¡®ç»´æŠ¤æ’ä»¶ç‰ˆæœ¬å·ã€‚
æ¨èä½¿ç”¨ Nx æä¾›çš„ **release æµç¨‹** è‡ªåŠ¨ç®¡ç†ç‰ˆæœ¬ï¼š

#### è‡ªåŠ¨ bump ç‰ˆæœ¬

```bash
npx nx release patch @xpert-ai/plugin-lark
```

* `patch`ï¼šä¿®å¤ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ 1.0.0 â†’ 1.0.1ï¼‰
* `minor`ï¼šå°ç‰ˆæœ¬æ›´æ–°ï¼ˆä¾‹å¦‚ 1.0.0 â†’ 1.1.0ï¼‰
* `major`ï¼šå¤§ç‰ˆæœ¬æ›´æ–°ï¼ˆä¾‹å¦‚ 1.0.0 â†’ 2.0.0ï¼‰

å‘½ä»¤ä¼šè‡ªåŠ¨ï¼š

1. ä¿®æ”¹ `package.json` ä¸­çš„ç‰ˆæœ¬å·ã€‚
2. æ›´æ–° `CHANGELOG.md`ã€‚
3. ç”Ÿæˆå¯¹åº”çš„ Git tagã€‚

> å¦‚æœä¸ä½¿ç”¨ `nx release`ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ `package.json` çš„ `version` å­—æ®µã€‚

### 7.3 å‘å¸ƒåˆ° npm

æ„å»ºå’Œç‰ˆæœ¬ bump å®Œæˆåï¼Œå°±å¯ä»¥æ‰§è¡Œå‘å¸ƒå‘½ä»¤ï¼š

```bash
npx nx run @xpert-ai/plugin-lark:nx-release-publish --access public --otp=<one-time-password-if-needed>
```

* `--access public`
  æŒ‡å®šåŒ…ä¸ºå…¬å¼€å‘å¸ƒï¼ˆé€‚ç”¨äº `@xpert-ai` è¿™ç§ npm scope ä¸‹çš„åŒ…ï¼‰ã€‚
* `--otp=<code>`
  å¦‚æœ npm è´¦å·å¼€å¯äº† **åŒå› ç´ è®¤è¯ (2FA)**ï¼Œéœ€è¦è¾“å…¥ä¸€æ¬¡æ€§å¯†ç  (OTP)ã€‚

> âš ï¸ æ³¨æ„ï¼šå‘å¸ƒå‰è¯·ç¡®è®¤ `package.json` ä¸­ä»¥ä¸‹å­—æ®µæ˜¯å¦æ­£ç¡®ï¼š
>
> * **`main`**ï¼šæŒ‡å‘æ„å»ºäº§ç‰©å…¥å£ï¼Œä¾‹å¦‚ `"dist/index.js"`
> * **`types`**ï¼šæŒ‡å‘ç±»å‹å£°æ˜ï¼Œä¾‹å¦‚ `"dist/index.d.ts"`
> * **`files`**ï¼šç¡®ä¿åªåŒ…å«éœ€è¦å‘å¸ƒçš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ `"dist/**/*"`ï¼‰
> * **`publishConfig`**ï¼šå¯å®šä¹‰é»˜è®¤å‘å¸ƒæƒé™ï¼ˆå¦‚ `"access": "public"`ï¼‰

### 7.4 æœ€ç»ˆæµç¨‹ç¤ºä¾‹

ç»¼åˆä¸Šè¿°æ­¥éª¤ï¼Œå‘å¸ƒ `@xpert-ai/plugin-lark` æ’ä»¶çš„å®Œæ•´å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
# 1. æ„å»ºæ’ä»¶
npx nx build @xpert-ai/plugin-lark

# 2. è‡ªåŠ¨ bump ç‰ˆæœ¬ï¼ˆæ­¤å¤„ä¸º patch ç‰ˆæœ¬ï¼‰
npx nx release patch @xpert-ai/plugin-lark

# 3. å‘å¸ƒåˆ° npm
npx nx run @xpert-ai/plugin-lark:nx-release-publish --access public --otp=<one-time-password-if-needed>
```

æ‰§è¡ŒæˆåŠŸåï¼Œnpm ä¸Šå°±èƒ½çœ‹åˆ°æœ€æ–°çš„ `@xpert-ai/plugin-lark` ç‰ˆæœ¬ã€‚ ğŸ‰

---

## 8. æœ€ç»ˆä½¿ç”¨æ•ˆæœ

å®Œæˆæ’ä»¶å¼€å‘åï¼Œä½ å¯ä»¥åœ¨ Xpert AI å¹³å°ä¸­ï¼š

* é…ç½®é£ä¹¦ AppID/AppSecret
* é€‰æ‹©æ–‡æ¡£æ–‡ä»¶å¤¹å’Œç±»å‹
* è‡ªåŠ¨åŠ è½½é£ä¹¦æ–‡æ¡£å†…å®¹
* å°†æ–‡æ¡£è½¬åŒ–ä¸ºçŸ¥è¯†åº“ï¼Œæ”¯æŒ AI å¯¹è¯å’Œæ™ºèƒ½ä½“åˆ†æ
