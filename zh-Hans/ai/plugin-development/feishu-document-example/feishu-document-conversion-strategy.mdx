---
sidebar_position: 6
title: é£ä¹¦æ–‡æ¡£è½¬æ¢ç­–ç•¥
---

## ä»£ç å›é¡¾

```ts
import { Injectable } from '@nestjs/common'
import { Document } from '@langchain/core/documents'
import {
  DocumentTransformerStrategy,
  IDocumentTransformerStrategy,
  IntegrationPermission,
  TDocumentTransformerConfig,
} from '@xpert-ai/plugin-sdk'
import { IconType, IKnowledgeDocument } from '@metad/contracts'
import { iconImage, LarkDocumentMetadata, LarkDocumentName, LarkName } from './types.js'
import { LarkClient } from './lark.client.js'

@Injectable()
@DocumentTransformerStrategy(LarkDocumentName)
export class LarkDocTransformerStrategy implements IDocumentTransformerStrategy<TDocumentTransformerConfig> {

  readonly permissions = [
    {
      type: 'integration',
      service: LarkName,
      description: 'Access to Lark system integrations'
    } as IntegrationPermission,
  ]

  readonly meta = {
    name: LarkDocumentName,
    label: {
      en_US: 'Lark Document',
      zh_Hans: 'é£ä¹¦æ–‡æ¡£'
    },
    description: {
      en_US: 'Load content from Lark documents',
      zh_Hans: 'åŠ è½½é£ä¹¦æ–‡æ¡£å†…å®¹'
    },
    icon: {
      type: 'image' as IconType,
      value: iconImage,
      color: '#14b8a6'
    },
    helpUrl: 'https://open.feishu.cn/document/server-docs/docs/docs-overview',
    configSchema: {
      type: 'object',
      properties: {},
      required: []
    }
  }

  validateConfig(config: any): Promise<void> {
    throw new Error('Method not implemented.')
  }

  async transformDocuments(
    files: Partial<IKnowledgeDocument<LarkDocumentMetadata>>[],
    config: TDocumentTransformerConfig
  ): Promise<Partial<IKnowledgeDocument<LarkDocumentMetadata>>[]> {
    const integration = config?.permissions?.integration
    if (!integration) {
      throw new Error('Integration system is required')
    }

    console.log('LarkDocTransformerStrategy transformDocuments', files, config)

    const client = new LarkClient(integration)
    
    const results: Partial<IKnowledgeDocument<LarkDocumentMetadata>>[] = []
    for await (const file of files) {
      const content = await client.getDocumentContent(file.metadata.token)
      results.push({
        id: file.id,
        chunks: [
          new Document({
            id: file.id,
            pageContent: content,
            metadata: {
              chunkId: file.id,
              source: LarkName,
              sourceId: file.id
            }
          })
        ],
        metadata: {
          assets: []
        } as LarkDocumentMetadata
      })
    }
    return results
  }
}
```

---

## é€»è¾‘æ‹†è§£

### 1. è£…é¥°å™¨ä¸ä¾èµ–æ³¨å…¥

```ts
@Injectable()
@DocumentTransformerStrategy(LarkDocumentName)
```

* `@Injectable()`ï¼šNestJS çš„ä¾èµ–æ³¨å…¥è£…é¥°å™¨ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¯æ³¨å…¥çš„æœåŠ¡ã€‚
* `@DocumentTransformerStrategy(LarkDocumentName)`ï¼šå°†å½“å‰ç±»æ³¨å†Œä¸º **æ–‡æ¡£è½¬æ¢ç­–ç•¥**ï¼Œå¹¶æŒ‡å®šå”¯ä¸€çš„åå­— `LarkDocumentName`ã€‚
  ğŸ‘‰ è¿™æ ·ç³»ç»Ÿå°±èƒ½è‡ªåŠ¨è¯†åˆ«å¹¶ä½¿ç”¨è¯¥ç­–ç•¥ã€‚

---

### 2. æƒé™å®šä¹‰

```ts
readonly permissions = [
  {
    type: 'integration',
    service: LarkName,
    description: 'Access to Lark system integrations'
  } as IntegrationPermission,
]
```

* æ’ä»¶éœ€è¦å…·å¤‡ **é£ä¹¦é›†æˆçš„æƒé™**ï¼Œå¦åˆ™æ— æ³•è°ƒç”¨ API è·å–æ–‡æ¡£ã€‚
* `IntegrationPermission` å£°æ˜äº†ä¾èµ–çš„æœåŠ¡ï¼Œè¿™é‡Œæ˜¯ `LarkName`ï¼ˆé£ä¹¦ï¼‰ã€‚

---

### 3. å…ƒä¿¡æ¯ï¼ˆmetaï¼‰

```ts
readonly meta = {
  name: LarkDocumentName,
  label: {
    en_US: 'Lark Document',
    zh_Hans: 'é£ä¹¦æ–‡æ¡£'
  },
  description: {
    en_US: 'Load content from Lark documents',
    zh_Hans: 'åŠ è½½é£ä¹¦æ–‡æ¡£å†…å®¹'
  },
  icon: {
    type: 'image' as IconType,
    value: iconImage,
    color: '#14b8a6'
  },
  helpUrl: 'https://open.feishu.cn/document/server-docs/docs/docs-overview',
  configSchema: { ... }
}
```

* **æ’ä»¶ UI å±•ç¤ºä¿¡æ¯**ï¼šåå­—ã€å›¾æ ‡ã€æè¿°ã€å¸®åŠ©æ–‡æ¡£é“¾æ¥ã€‚
* `configSchema`ï¼šå®šä¹‰é…ç½®é¡¹ï¼ˆè¿™é‡Œä¸ºç©ºï¼Œè¡¨ç¤ºæ— éœ€é¢å¤–å‚æ•°ï¼‰ã€‚

---

### 4. é…ç½®æ ¡éªŒ

```ts
validateConfig(config: any): Promise<void> {
  throw new Error('Method not implemented.')
}
```

* å ä½æ–¹æ³•ï¼Œç”¨äºæœªæ¥å¯¹é…ç½®è¿›è¡Œæ ¡éªŒã€‚
* ä¾‹å¦‚ï¼šæ£€æŸ¥æ˜¯å¦ä¼ å…¥äº†æ–‡æ¡£ ID æˆ– Tokenã€‚

---

### 5. æ–‡æ¡£è½¬æ¢æ ¸å¿ƒé€»è¾‘

```ts
async transformDocuments(
  files: Partial<IKnowledgeDocument<LarkDocumentMetadata>>[],
  config: TDocumentTransformerConfig
): Promise<Partial<IKnowledgeDocument<LarkDocumentMetadata>>[]> {
  const integration = config?.permissions?.integration
  if (!integration) {
    throw new Error('Integration system is required')
  }

  const client = new LarkClient(integration)
  
  const results: Partial<IKnowledgeDocument<LarkDocumentMetadata>>[] = []
  for await (const file of files) {
    const content = await client.getDocumentContent(file.metadata.token)
    results.push({
      id: file.id,
      chunks: [
        new Document({
          id: file.id,
          pageContent: content,
          metadata: {
            chunkId: file.id,
            source: LarkName,
            sourceId: file.id
          }
        })
      ],
      metadata: {
        assets: []
      } as LarkDocumentMetadata
    })
  }
  return results
}
```

é€è¡Œè§£æï¼š

1. **è·å–é›†æˆä¿¡æ¯**

   ```ts
   const integration = config?.permissions?.integration
   if (!integration) throw new Error('Integration system is required')
   ```

   * ä»é…ç½®ä¸­å–å‡ºé£ä¹¦çš„é›†æˆå‡­è¯ã€‚
   * å¦‚æœç¼ºå°‘å‡­è¯ï¼Œåˆ™æŠ¥é”™ã€‚

2. **åˆå§‹åŒ–å®¢æˆ·ç«¯**

   ```ts
   const client = new LarkClient(integration)
   ```

   * ä½¿ç”¨å‡­è¯æ„é€  `LarkClient`ï¼Œç”¨æ¥è®¿é—®é£ä¹¦ APIã€‚

3. **å¾ªç¯å¤„ç†æ–‡ä»¶**

   ```ts
   for await (const file of files) {
     const content = await client.getDocumentContent(file.metadata.token)
   }
   ```

   * éå†å¾…å¤„ç†çš„æ–‡æ¡£åˆ—è¡¨ã€‚
   * è°ƒç”¨ `client.getDocumentContent` æ ¹æ® `token` æ‹‰å–æ–‡æ¡£æ­£æ–‡ã€‚

4. **æ„å»ºè½¬æ¢åçš„æ–‡æ¡£**

   ```ts
   results.push({
     id: file.id,
     chunks: [
       new Document({
         id: file.id,
         pageContent: content,
         metadata: {
           chunkId: file.id,
           source: LarkName,
           sourceId: file.id
         }
       })
     ],
     metadata: {
       assets: []
     } as LarkDocumentMetadata
   })
   ```

   * æ¯ä¸ªé£ä¹¦æ–‡æ¡£è¢«è½¬åŒ–ä¸ºä¸€ä¸ª `IKnowledgeDocument`ã€‚
   * æ ¸å¿ƒå†…å®¹æ”¾åœ¨ `chunks` æ•°ç»„ä¸­ã€‚
   * `metadata` å­˜å‚¨é¢å¤–ä¿¡æ¯ï¼ˆè¿™é‡Œæš‚æ—¶åªæœ‰ `assets`ï¼‰ã€‚

---

## æ•´ä½“æ‰§è¡Œæµç¨‹

1. **è¾“å…¥**ï¼šä¸€æ‰¹é£ä¹¦æ–‡æ¡£çš„å…ƒä¿¡æ¯ï¼ˆæ–‡ä»¶ ID / Tokenï¼‰ã€‚
2. **éªŒè¯æƒé™**ï¼šç¡®ä¿æœ‰é£ä¹¦çš„é›†æˆé…ç½®ã€‚
3. **API è°ƒç”¨**ï¼šä½¿ç”¨ `LarkClient` æ‹‰å–æ¯ä¸ªæ–‡æ¡£çš„æ­£æ–‡ã€‚
4. **è½¬åŒ–ä¸ºçŸ¥è¯†åº“æ ¼å¼**ï¼š

   * åŒ…è£…ä¸º `IKnowledgeDocument`
   * å†…å®¹åˆ‡åˆ†ä¸º `Document`ï¼ˆä¾¿äºåç»­å‘é‡åŒ–å¤„ç†ï¼‰
5. **è¾“å‡º**ï¼šè¿”å›å¯è¢« Xpert AI çŸ¥è¯†åº“ä½¿ç”¨çš„æ–‡æ¡£æ•°ç»„ã€‚

---

## æ ¸å¿ƒä»·å€¼

* **è§£è€¦**ï¼šç­–ç•¥ç±»ä¸ç›´æ¥è°ƒç”¨ APIï¼Œè€Œæ˜¯ä¾èµ– `LarkClient`ã€‚
* **é€šç”¨æ€§**ï¼šæ‰€æœ‰æ–‡æ¡£æœ€ç»ˆè¢«ç»Ÿä¸€è½¬åŒ–ä¸º `IKnowledgeDocument`ï¼Œä¸å¹³å°çš„çŸ¥è¯†åº“æ— ç¼å¯¹æ¥ã€‚
* **å¯æ‰©å±•**ï¼šæœªæ¥å¯ä»¥åœ¨ `transformDocuments` ä¸­åŠ å…¥ï¼š

  * æ–‡æœ¬æ¸…ç†ï¼ˆå»æ‰ç©ºè¡Œ/æ ¼å¼ï¼‰
  * å†…å®¹åˆ‡åˆ†ï¼ˆchunkingï¼‰
  * å…ƒæ•°æ®å¢å¼ºï¼ˆä½œè€…ã€æ ‡ç­¾ã€æ›´æ–°æ—¶é—´ï¼‰
